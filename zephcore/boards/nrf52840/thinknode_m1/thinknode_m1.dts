/*
 * Elecrow ThinkNode M1 — nRF52840 + SX1262 + SSD1681 1.54" EPD
 * Copyright (c) 2025 ZephCore
 *
 * SPDX-License-Identifier: Apache-2.0
 *
 * Hardware:
 * - nRF52840 SoC with BLE 5
 * - SX1262 LoRa radio (DIO2 as RF switch, external TCXO 1.8V)
 * - SSD1681 1.54" 200x200 monochrome e-paper display (SPI)
 * - MX25R1635F 2MB QSPI flash
 * - GPS module on UART0 (9600 baud, multi-constellation)
 * - 1200 mAh battery with ADC on AIN2 (150K+150K divider)
 * - Buzzer on PWM0, two user buttons, GPS hardware switch
 * - LEDs: GREEN=P1.04, BLUE=P0.14 (RED=P1.06 shared with display SPI)
 *
 * Pin conflicts (shared by hardware design):
 * - P1.06: LED_RED + display SPI MISO (EPD is write-only, MISO unused)
 * - P1.05: LoRa power enable + GPS reset (shared power rail)
 * - P1.04: LED_GREEN + GPS PPS (GPS PPS blinks the green LED)
 */

/dts-v1/;
#include <nordic/nrf52840_qiaa.dtsi>
#include "thinknode_m1-pinctrl.dtsi"
#include <zephyr/dt-bindings/lora/sx126x.h>
#include <zephyr/dt-bindings/adc/nrf-saadc.h>
#include <zephyr/dt-bindings/input/input-event-codes.h>
#include <zephyr/dt-bindings/pwm/pwm.h>

/ {
	model = "Elecrow ThinkNode M1";
	compatible = "elecrow,thinknode-m1";

	chosen {
		zephyr,sram = &sram0;
		zephyr,flash = &flash0;
		zephyr,code-partition = &code_partition;
		zephyr,console = &cdc_acm_uart;
		zephyr,shell-uart = &cdc_acm_uart;
		zephyr,display = &epd;
	};

	aliases {
		lora0 = &lora;
		led0 = &led_green;
		led1 = &led_blue;
		sw0 = &user_button;
		watchdog0 = &wdt0;
		buzzer = &buzzer;
		gps-enable = &gps_enable_pin;
	};

	/* ---- LEDs (active-low) ---- */
	leds {
		compatible = "gpio-leds";

		led_green: led_0 {
			gpios = <&gpio1 4 GPIO_ACTIVE_LOW>;
			label = "Green LED";
		};

		led_blue: led_1 {
			gpios = <&gpio0 14 GPIO_ACTIVE_LOW>;
			label = "Blue LED";
		};
		/* LED_RED (P1.06) omitted — shared with display SPI MISO */
	};

	/* ---- Buttons ---- */
	buttons: buttons {
		compatible = "gpio-keys";

		user_button: button_0 {
			gpios = <&gpio1 10 (GPIO_PULL_UP | GPIO_ACTIVE_LOW)>;
			zephyr,code = <INPUT_KEY_0>;
			label = "User Button";
		};

		page_button: button_1 {
			gpios = <&gpio0 11 (GPIO_PULL_UP | GPIO_ACTIVE_LOW)>;
			zephyr,code = <INPUT_KEY_1>;
			label = "Page Button";
		};
	};

	/* Input filter: user button long-press (1000ms) */
	user_btn_longpress {
		compatible = "zephyr,input-longpress";
		input = <&buttons>;
		input-codes = <INPUT_KEY_0>;
		short-codes = <INPUT_KEY_A>;
		long-codes = <INPUT_KEY_POWER>;
		long-delay-ms = <1000>;
	};

	/* Input filter: user button multi-tap
	 * 1 tap  → KEY_1 = next page on EPD
	 * 2 taps → KEY_B = flood advert
	 * 3 taps → KEY_D = buzzer mute toggle
	 * 4 taps → KEY_C = GPS on/off */
	user_btn_multitap {
		compatible = "zephcore,input-multi-tap";
		input-codes = <INPUT_KEY_A>;
		tap-codes = <INPUT_KEY_1 INPUT_KEY_B INPUT_KEY_D INPUT_KEY_C>;
		tap-delay-ms = <400>;
	};

	/* ---- Power control ---- */

	/* Board power enable — must be HIGH for peripherals to function */
	pwr_enable: pwr-enable {
		compatible = "regulator-fixed";
		regulator-name = "pwr-enable";
		enable-gpios = <&gpio0 12 GPIO_ACTIVE_HIGH>;
		regulator-boot-on;
	};

	/* LoRa radio power enable — must be HIGH before SX1262 can communicate */
	lora_pwr_enable: lora-pwr-enable {
		compatible = "regulator-fixed";
		regulator-name = "lora-pwr-enable";
		enable-gpios = <&gpio1 5 GPIO_ACTIVE_HIGH>;
		regulator-boot-on;
		startup-delay-us = <10000>;
	};

	/* External TCXO power enable — SX1262 DIO3 provides reference voltage,
	 * but the TCXO itself is powered through this separate GPIO */
	tcxo_enable: tcxo-enable {
		compatible = "regulator-fixed";
		regulator-name = "tcxo-enable";
		enable-gpios = <&gpio0 21 GPIO_ACTIVE_HIGH>;
		regulator-boot-on;
	};

	/* ---- GPS hardware switch (P1.01) ----
	 * Physical toggle switch on the board.
	 * HIGH = GPS ON, LOW = GPS OFF.
	 * Separate from the buttons node so it doesn't feed
	 * the longpress/multi-tap filter chain. */
	gps_switch: gps-switch {
		compatible = "gpio-keys";
		gps_sw: gps_sw {
			gpios = <&gpio1 1 GPIO_ACTIVE_HIGH>;
			zephyr,code = <INPUT_KEY_G>;
			label = "GPS Switch";
		};
	};

	/* GPS power control */
	gps_en: gps-enable {
		compatible = "gpio-leds";
		gps_enable_pin: gps_enable {
			gpios = <&gpio1 2 GPIO_ACTIVE_HIGH>;
			label = "GPS Enable";
		};
	};

	/* ---- Battery ADC ---- */
	/* 150K+150K voltage divider (2:1) on AIN2 (P0.04) */
	zephyr,user {
		io-channels = <&adc 2>;
		vbat-mv-multiplier = <7200>;
	};

	/* ---- Buzzer on PWM0 ---- */
	pwmbuzzer {
		compatible = "pwm-leds";
		buzzer: buzzer {
			pwms = <&pwm0 0 PWM_MSEC(20) PWM_POLARITY_NORMAL>;
		};
	};

	/* ---- E-Paper display (MIPI DBI SPI) ----
	 * SSD1681 1.54" 200x200 monochrome EPD on SPI3.
	 * The MIPI DBI node wraps the SPI bus with DC and RST GPIOs.
	 * Display is auto-detected by ZephCore display.c via the
	 * zephyr,display chosen node — EPD flag set automatically. */
	mipi_dbi {
		compatible = "zephyr,mipi-dbi-spi";
		spi-dev = <&spi3>;
		dc-gpios = <&gpio0 28 GPIO_ACTIVE_HIGH>;
		reset-gpios = <&gpio0 2 GPIO_ACTIVE_LOW>;
		#address-cells = <1>;
		#size-cells = <0>;

		epd: ssd16xxfb@0 {
			compatible = "solomon,ssd1681";
			mipi-max-frequency = <4000000>;
			reg = <0>;
			width = <200>;
			height = <200>;
			busy-gpios = <&gpio0 3 GPIO_ACTIVE_HIGH>;
		};
	};
};

/* ---- SoC configuration ---- */

&reg0 {
	status = "okay";
};

&reg1 {
	regulator-initial-mode = <NRF5X_REG_MODE_DCDC>;
};

&adc {
	status = "okay";
	#address-cells = <1>;
	#size-cells = <0>;

	/* Battery voltage on P0.04 (AIN2) */
	channel@2 {
		reg = <2>;
		zephyr,gain = "ADC_GAIN_1_6";
		zephyr,reference = "ADC_REF_INTERNAL";
		zephyr,acquisition-time = <ADC_ACQ_TIME(ADC_ACQ_TIME_MICROSECONDS, 10)>;
		zephyr,input-positive = <NRF_SAADC_AIN2>;
		zephyr,resolution = <12>;
	};
};

&uicr {
	nfct-pins-as-gpios;
};

&gpiote {
	status = "okay";
};

&gpio0 {
	status = "okay";
};

&gpio1 {
	status = "okay";
};

/* ---- PWM0 for buzzer ---- */
&pwm0 {
	status = "okay";
	pinctrl-0 = <&pwm0_default>;
	pinctrl-1 = <&pwm0_sleep>;
	pinctrl-names = "default", "sleep";
};

/* ---- GPS on UART0 (9600 baud) ----
 * Uses luatos,air530z driver (PCAS/NMEA protocol).
 * GPS power controlled via on-off-gpios (P1.02 = GPS_EN). */
&uart0 {
	compatible = "nordic,nrf-uarte";
	status = "okay";
	current-speed = <9600>;
	pinctrl-0 = <&uart0_default>;
	pinctrl-1 = <&uart0_sleep>;
	pinctrl-names = "default", "sleep";

	gnss: gnss {
		compatible = "luatos,air530z";
		on-off-gpios = <&gpio1 2 GPIO_ACTIVE_HIGH>;
	};
};

/* ---- I2C0 for RTC and external sensors ---- */
&i2c0 {
	compatible = "nordic,nrf-twim";
	status = "okay";
	clock-frequency = <I2C_BITRATE_FAST>;
	pinctrl-0 = <&i2c0_default>;
	pinctrl-1 = <&i2c0_sleep>;
	pinctrl-names = "default", "sleep";

	/* All supported environment & power sensors — auto-detected at runtime */
	#include "../../common/sensors-i2c.dtsi"
};

/* ---- SPI2 for LoRa SX1262 ---- */
&spi2 {
	compatible = "nordic,nrf-spim";
	status = "okay";
	pinctrl-0 = <&spi2_default>;
	pinctrl-1 = <&spi2_sleep>;
	pinctrl-names = "default", "sleep";
	cs-gpios = <&gpio0 24 GPIO_ACTIVE_LOW>;   /* P0.24 LORA_CS */

	lora: lora@0 {
		compatible = "semtech,sx1262";
		reg = <0>;
		spi-max-frequency = <8000000>;

		/* LoRa control pins */
		reset-gpios = <&gpio0 25 GPIO_ACTIVE_LOW>;    /* P0.25 */
		busy-gpios = <&gpio0 17 GPIO_ACTIVE_HIGH>;    /* P0.17 */
		dio1-gpios = <&gpio0 20 (GPIO_PULL_DOWN | GPIO_ACTIVE_HIGH)>;  /* P0.20 */

		/* DIO2 drives RF switch for TX */
		dio2-tx-enable;

		/* TCXO voltage 1.8V via DIO3 */
		dio3-tcxo-voltage = <SX126X_DIO3_TCXO_1V8>;
		tcxo-power-startup-delay-ms = <10>;

		/* RX boosted mode for better sensitivity */
		rx-boosted;
	};
};

/* ---- SPI3 for E-Paper display ---- */
&spi3 {
	compatible = "nordic,nrf-spim";
	status = "okay";
	pinctrl-0 = <&spi3_default>;
	pinctrl-1 = <&spi3_sleep>;
	pinctrl-names = "default", "sleep";
	cs-gpios = <&gpio0 30 GPIO_ACTIVE_LOW>;   /* P0.30 DISP_CS */
};

/* ---- QSPI Flash — MX25R1635F 2MB ---- */
&qspi {
	status = "okay";
	pinctrl-0 = <&qspi_default>;
	pinctrl-1 = <&qspi_sleep>;
	pinctrl-names = "default", "sleep";

	qspi_flash: qspi_flash@0 {
		compatible = "nordic,qspi-nor";
		reg = <0>;
		writeoc = "pp";
		readoc = "fastread";
		sck-frequency = <16000000>;
		jedec-id = [c2 28 15];        /* MX25R1635F */
		size = <16777216>;            /* 2MB = 16Mbit */
		has-dpd;
		t-enter-dpd = <10000>;
		t-exit-dpd = <35000>;
	};
};

/* ---- USB CDC for console/CLI ---- */
zephyr_udc0: &usbd {
	compatible = "nordic,nrf-usbd";
	status = "okay";

	cdc_acm_uart: cdc_acm_uart {
		compatible = "zephyr,cdc-acm-uart";
	};
};

/* ---- Flash partitions (SoftDevice v6, app@0x26000) ---- */
#include "../../common/nrf52_partitions_sdv6.dtsi"

/* ---- External QSPI flash partitions ---- */
&qspi_flash {
	partitions {
		compatible = "fixed-partitions";
		#address-cells = <1>;
		#size-cells = <1>;

		/* Full 2MB for LittleFS storage */
		qspi_storage_partition: partition@0 {
			label = "qspi_storage";
			reg = <0x00000000 0x00200000>;
		};
	};
};

/* ---- External QSPI /ext automount ---- */
#include "../../common/qspi-ext.dtsi"
