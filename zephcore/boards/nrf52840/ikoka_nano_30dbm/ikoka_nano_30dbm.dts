/*
 * SPDX-License-Identifier: Apache-2.0
 * Ikoka Nano 30dBm - XIAO nRF52840 + E22-900M30S LoRa module
 *
 * E22-900M30S LoRa Module:
 * - SX1262 with integrated 30dBm PA
 * - RXEN (P1.12/D7) control: HIGH for RX, LOW for TX
 * - Input power limited to 20dBm (30dBm output)
 * - DIO2 as RF switch, TCXO 1.8V
 *
 * Pin Mapping (XIAO D-pins to nRF52840 GPIOs):
 * - D0  = P0.02 (NSS)      - D4 = P0.04 (SDA)   - D8  = P1.13 (SCK)
 * - D1  = P0.03 (DIO1)     - D5 = P0.05 (SCL)   - D9  = P1.14 (MISO)
 * - D2  = P0.28 (BUSY)     - D6 = P1.11 (TX)    - D10 = P1.15 (MOSI)
 * - D3  = P0.29 (RESET)    - D7 = P1.12 (RXEN)
 *
 * Battery: P0.31/AIN7 with enable on P0.14
 * LEDs: RED=P0.26/D11, BLUE=P0.06/D12, GREEN=P0.30/D13
 */

/dts-v1/;
#include <nordic/nrf52840_qiaa.dtsi>
#include "ikoka_nano_30dbm-pinctrl.dtsi"
#include <zephyr/dt-bindings/adc/nrf-saadc.h>
#include <zephyr/dt-bindings/lora/sx126x.h>

/ {
	model = "Ikoka Nano 30dBm";
	compatible = "ikoka,nano-30dbm";

	chosen {
		zephyr,sram = &sram0;
		zephyr,flash = &flash0;
		zephyr,code-partition = &code_partition;
		zephyr,console = &cdc_acm_uart;
		zephyr,shell-uart = &cdc_acm_uart;
	};

	aliases {
		lora0 = &lora;
		led0 = &led_red;
		led1 = &led_green;
		led2 = &led_blue;
		watchdog0 = &wdt0;
	};

	/* Status LEDs - active LOW on XIAO */
	leds {
		compatible = "gpio-leds";
		led_red: led_0 {
			gpios = <&gpio0 26 GPIO_ACTIVE_LOW>;
			label = "Red LED";
		};
		led_green: led_1 {
			gpios = <&gpio0 30 GPIO_ACTIVE_LOW>;
			label = "Green LED";
		};
		led_blue: led_2 {
			gpios = <&gpio0 6 GPIO_ACTIVE_LOW>;
			label = "Blue LED";
		};
	};

	/* Battery ADC enable - P0.14 must be LOW to read battery */
	vbat_enable: vbat-enable {
		compatible = "regulator-fixed";
		regulator-name = "vbat-enable";
		enable-gpios = <&gpio0 14 GPIO_ACTIVE_LOW>;
		regulator-boot-on;
	};

	/* Battery ADC channel */
	zephyr,user {
		io-channels = <&adc 7>;
		vbat-mv-multiplier = <10650>;  /* 1M/510k divider (2.96x), 3.6V ref */
	};
};

&reg0 {
	status = "okay";
};

&reg1 {
	regulator-initial-mode = <NRF5X_REG_MODE_DCDC>;
};

&adc {
	status = "okay";
	#address-cells = <1>;
	#size-cells = <0>;

	channel@7 {
		reg = <7>;
		zephyr,gain = "ADC_GAIN_1_6";
		zephyr,reference = "ADC_REF_INTERNAL";
		zephyr,acquisition-time = <ADC_ACQ_TIME(ADC_ACQ_TIME_MICROSECONDS, 10)>;
		zephyr,input-positive = <NRF_SAADC_AIN7>;
		zephyr,resolution = <12>;
	};
};

&uicr {
	gpio-as-nreset;
};

&gpiote {
	status = "okay";
};

&gpio0 {
	status = "okay";
};

&gpio1 {
	status = "okay";
};

/* I2C1 on D4/D5 for external sensors */
&i2c1 {
	compatible = "nordic,nrf-twi";
	status = "okay";
	pinctrl-0 = <&i2c1_default>;
	pinctrl-1 = <&i2c1_sleep>;
	pinctrl-names = "default", "sleep";

	/* All supported environment & power sensors â€” auto-detected at runtime */
	#include "../../common/sensors-i2c.dtsi"
};

/* SPI2 for LoRa module */
&spi2 {
	compatible = "nordic,nrf-spi";
	status = "okay";
	pinctrl-0 = <&spi2_default>;
	pinctrl-1 = <&spi2_sleep>;
	pinctrl-names = "default", "sleep";
	cs-gpios = <&gpio0 2 GPIO_ACTIVE_LOW>;  /* D0 = P0.02 NSS */

	lora: lora@0 {
		compatible = "semtech,sx1262";
		reg = <0>;
		spi-max-frequency = <8000000>;

		/* LoRa control pins */
		reset-gpios = <&gpio0 29 GPIO_ACTIVE_LOW>;   /* D3 = P0.29 */
		busy-gpios = <&gpio0 28 GPIO_ACTIVE_HIGH>;   /* D2 = P0.28 */
		dio1-gpios = <&gpio0 3 (GPIO_PULL_DOWN | GPIO_ACTIVE_HIGH)>;  /* D1 = P0.03 */

		/* E22-900M30S PA control */
		rx-enable-gpios = <&gpio1 12 GPIO_ACTIVE_HIGH>;  /* D7 = P1.12 RXEN */

		/* Use DIO2 to drive TX enable on RF switch */
		dio2-tx-enable;

		/* TCXO voltage 1.8V */
		dio3-tcxo-voltage = <SX126X_DIO3_TCXO_1V8>;
		tcxo-power-startup-delay-ms = <10>;

		/* Enable RX boosted mode for better sensitivity */
		rx-boosted;
	};
};

/* QSPI Flash - P25Q16H (2MB) on XIAO nRF52840
 * Disabled: Flash chip appears damaged or locked on this unit.
 * Re-enable with status = "okay" if working QSPI flash is needed. */
&qspi {
	status = "disabled";
};

/* USB CDC for console/CLI */
zephyr_udc0: &usbd {
	compatible = "nordic,nrf-usbd";
	status = "okay";

	cdc_acm_uart: cdc_acm_uart {
		compatible = "zephyr,cdc-acm-uart";
	};
};

/* Arduino MeshCore compatible partition layout (SoftDevice v7) */
#include "../../common/nrf52_partitions_sdv7.dtsi"
