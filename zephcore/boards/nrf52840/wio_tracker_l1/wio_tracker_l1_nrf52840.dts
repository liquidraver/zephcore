/*
 * Seeed Wio Tracker L1 - nRF52840 + SX1262
 * Copyright (c) 2025 ZephCore
 *
 * SPDX-License-Identifier: Apache-2.0
 *
 * Hardware:
 * - nRF52840 SoC with BLE
 * - SX1262 LoRa radio (DIO2 as RF switch, TCXO 1.8V)
 * - P25Q16H 2MB QSPI flash
 * - SH1106 OLED display (I2C 0x3D)
 * - L76KB GPS module
 * - Joystick + user button
 * - Battery voltage ADC
 */

/dts-v1/;
#include <nordic/nrf52840_qiaa.dtsi>
#include <nordic/nrf52840_partition.dtsi>
#include <zephyr/dt-bindings/lora/sx126x.h>
#include <zephyr/dt-bindings/adc/nrf-saadc.h>
#include <zephyr/dt-bindings/input/input-event-codes.h>
#include <zephyr/dt-bindings/pwm/pwm.h>
#include "wio_tracker_l1_nrf52840-pinctrl.dtsi"

/* Delete default partitions from nrf52840_partition.dtsi */
/delete-node/ &boot_partition;
/delete-node/ &slot0_partition;
/delete-node/ &slot1_partition;
/delete-node/ &storage_partition;

/ {
	model = "Seeed Wio Tracker L1";
	compatible = "seeed,wio-tracker-l1";

	chosen {
		zephyr,code-partition = &code_partition;
		zephyr,console = &cdc_acm_uart;
		zephyr,shell-uart = &cdc_acm_uart;
		zephyr,display = &sh1106;
	};

	leds {
		compatible = "gpio-leds";

		user_led: led_0 {
			gpios = <&gpio1 1 GPIO_ACTIVE_HIGH>;
			label = "User LED";
		};
	};

	buttons: buttons {
		compatible = "gpio-keys";

		user_button: button_0 {
			gpios = <&gpio0 8 (GPIO_PULL_UP | GPIO_ACTIVE_LOW)>;
			zephyr,code = <INPUT_KEY_0>;
			label = "User Button";
		};

		joystick_up: button_1 {
			gpios = <&gpio1 4 (GPIO_PULL_UP | GPIO_ACTIVE_LOW)>;
			zephyr,code = <INPUT_KEY_UP>;
			label = "Joystick Up";
		};

		joystick_down: button_2 {
			gpios = <&gpio0 12 (GPIO_PULL_UP | GPIO_ACTIVE_LOW)>;
			zephyr,code = <INPUT_KEY_DOWN>;
			label = "Joystick Down";
		};

		joystick_left: button_3 {
			gpios = <&gpio0 11 (GPIO_PULL_UP | GPIO_ACTIVE_LOW)>;
			zephyr,code = <INPUT_KEY_LEFT>;
			label = "Joystick Left";
		};

		joystick_right: button_4 {
			gpios = <&gpio1 3 (GPIO_PULL_UP | GPIO_ACTIVE_LOW)>;
			zephyr,code = <INPUT_KEY_RIGHT>;
			label = "Joystick Right";
		};

		joystick_press: button_5 {
			gpios = <&gpio1 5 (GPIO_PULL_UP | GPIO_ACTIVE_LOW)>;
			zephyr,code = <INPUT_KEY_ENTER>;
			label = "Joystick Press";
		};
	};

	/* Input filter: user button long-press detection (1000ms) */
	user_btn_longpress {
		compatible = "zephyr,input-longpress";
		input = <&buttons>;
		input-codes = <INPUT_KEY_0>;
		short-codes = <INPUT_KEY_A>;
		long-codes = <INPUT_KEY_POWER>;
		long-delay-ms = <1000>;
	};

	/* Input filter: user button multi-tap detection
	 * 1 tap  (400ms wait) → KEY_1 = page next on OLED
	 * 2 taps (400ms wait) → KEY_B = flood advert
	 * 3 taps (400ms wait) → KEY_D = buzzer mute toggle
	 * 4 taps (immediate)  → KEY_C = GPS on/off */
	user_btn_multitap {
		compatible = "zephcore,input-multi-tap";
		/* No 'input' phandle — listen to ALL devices.
		 * KEY_A is emitted by the longpress pseudo-device,
		 * not by &buttons, so we must not filter by device. */
		input-codes = <INPUT_KEY_A>;
		tap-codes = <INPUT_KEY_1 INPUT_KEY_B INPUT_KEY_D INPUT_KEY_C>;
		tap-delay-ms = <400>;
	};

	/* Battery voltage enable and ADC - on-demand only to save power */
	vbat_enable: vbat-enable {
		compatible = "regulator-fixed";
		regulator-name = "vbat-enable";
		enable-gpios = <&gpio0 4 GPIO_ACTIVE_HIGH>;
		/* NOT regulator-boot-on - enabled on-demand in ZephyrBoard.cpp */
	};

	/* Battery ADC channel reference for ZephyrBoard */
	zephyr,user {
		io-channels = <&adc 7>;
		vbat-mv-multiplier = <7200>;  /* 2:1 voltage divider, 3.6V ref */
	};

	/* Buzzer on PWM0 channel 0 (P1.00) - no enable pin needed */
	pwmbuzzer {
		compatible = "pwm-leds";
		buzzer: buzzer {
			pwms = <&pwm0 0 PWM_MSEC(20) PWM_POLARITY_NORMAL>;
		};
	};

	aliases {
		led0 = &user_led;
		sw0 = &user_button;
		lora0 = &lora;
		watchdog0 = &wdt0;
		buzzer = &buzzer;
	};
};

&reg0 {
	status = "okay";
};

&reg1 {
	regulator-initial-mode = <NRF5X_REG_MODE_DCDC>;
};

&adc {
	status = "okay";
	#address-cells = <1>;
	#size-cells = <0>;

	/* Battery voltage on P0.31 (AIN7) */
	channel@7 {
		reg = <7>;
		zephyr,gain = "ADC_GAIN_1_6";
		zephyr,reference = "ADC_REF_INTERNAL";
		zephyr,acquisition-time = <ADC_ACQ_TIME(ADC_ACQ_TIME_MICROSECONDS, 10)>;
		zephyr,input-positive = <NRF_SAADC_AIN7>;
		zephyr,resolution = <12>;
	};
};

&uicr {
	nfct-pins-as-gpios;
};

&gpiote {
	status = "okay";
};

&gpio0 {
	status = "okay";
};

&gpio1 {
	status = "okay";

	/* NOTE: buzzer-off gpio-hog REMOVED - buzzer pin is now managed by PWM
	 * driver. When PWM is not driving, the pin is low (no current draw). */

	/* NOTE: GPS enable hog REMOVED - Feb 6 working version had no GPIO hog
	 * and GPS worked fine. The L76KB module may have internal pull-up or
	 * the Arduino bootloader leaves it enabled. */
};

/* PWM0 for buzzer */
&pwm0 {
	status = "okay";
	pinctrl-0 = <&pwm0_default>;
	pinctrl-1 = <&pwm0_sleep>;
	pinctrl-names = "default", "sleep";
};

/* GPS L76KB module - NOTE: Feb 6 working version had no GPIO control nodes.
 * The GPS just worked without any power control! Keeping it simple. */

/* Quectel L76KB GNSS on UART0 - 9600 baud (PCAS/CASIC protocol)
 * Uses Zephyr luatos,air530z driver (same PCAS command set for
 * constellation config via PCAS04, fix rate via PCAS02, etc.)
 * on-off-gpios = GPS enable pin (P1.09), managed by driver. */
&uart0 {
	compatible = "nordic,nrf-uarte";
	status = "okay";
	current-speed = <9600>;
	pinctrl-0 = <&uart0_default>;
	pinctrl-1 = <&uart0_sleep>;
	pinctrl-names = "default", "sleep";
	/* No hw-flow-control - GPS doesn't use RTS/CTS */

	gnss: gnss {
		compatible = "luatos,air530z";
		on-off-gpios = <&gpio1 9 GPIO_ACTIVE_HIGH>;
	};
};

/* I2C0 for OLED display + sensors */
&i2c0 {
	compatible = "nordic,nrf-twim";
	status = "okay";
	clock-frequency = <I2C_BITRATE_FAST>;
	pinctrl-0 = <&i2c0_default>;
	pinctrl-1 = <&i2c0_sleep>;
	pinctrl-names = "default", "sleep";
	/* SH1106 sends 1 cmd + 128 data = 129 bytes per page write.
	 * nRF TWIM needs an internal buffer >= this size. */
	zephyr,concat-buf-size = <256>;
	zephyr,flash-buf-max-size = <256>;

	sh1106: sh1106@3d {
		compatible = "sinowealth,sh1106";
		reg = <0x3d>;
		width = <128>;
		height = <64>;
		segment-offset = <2>;    /* SH1106 has 2-column offset */
		page-offset = <0>;
		display-offset = <0>;
		multiplex-ratio = <63>;
		segment-remap;
		com-invdir;
		prechargep = <0x22>;
	};

	/* All supported environment & power sensors — auto-detected at runtime */
	#include "../../common/sensors-i2c.dtsi"
};

/* I2C1 for Grove connector - disabled by default */
&i2c1 {
	compatible = "nordic,nrf-twim";
	status = "disabled";
	pinctrl-0 = <&i2c1_default>;
	pinctrl-1 = <&i2c1_sleep>;
	pinctrl-names = "default", "sleep";
};

/* SPI1 for LoRa SX1262 (SPI0 conflicts with I2C0 on same serial instance) */
&spi1 {
	compatible = "nordic,nrf-spim";
	status = "okay";
	cs-gpios = <&gpio1 14 GPIO_ACTIVE_LOW>;
	pinctrl-0 = <&spi1_default>;
	pinctrl-1 = <&spi1_sleep>;
	pinctrl-names = "default", "sleep";

	lora: lora@0 {
		compatible = "semtech,sx1262";
		reg = <0>;
		reset-gpios = <&gpio1 7 GPIO_ACTIVE_LOW>;
		busy-gpios = <&gpio1 10 GPIO_ACTIVE_HIGH>;
		dio1-gpios = <&gpio0 7 (GPIO_PULL_DOWN | GPIO_ACTIVE_HIGH)>;
		/* RXEN on P1.08, DIO2 as RF switch for TX */
		rx-enable-gpios = <&gpio1 8 GPIO_ACTIVE_HIGH>;
		dio2-tx-enable;
		dio3-tcxo-voltage = <SX126X_DIO3_TCXO_1V8>;
		tcxo-power-startup-delay-ms = <5>;
		spi-max-frequency = <8000000>;
		rx-boosted;
	};
};

/* QSPI Flash - P25Q16H 2MB - single-bit mode at 16MHz (matches Arduino) */
&qspi {
	status = "okay";
	pinctrl-0 = <&qspi_default>;
	pinctrl-1 = <&qspi_sleep>;
	pinctrl-names = "default", "sleep";

	qspi_flash: qspi_flash@0 {
		compatible = "nordic,qspi-nor";
		reg = <0>;
		writeoc = "pp";           /* Single-bit page program (universal) */
		readoc = "fastread";      /* Single-bit fast read (universal) */
		sck-frequency = <16000000>; /* 16 MHz (matches Arduino) */
		jedec-id = [85 60 15];    /* P25Q16H */
		sfdp-bfp = [
			e5 20 f1 ff  ff ff ff 01  44 eb 08 6b  08 3b 04 bb
			ee ff ff ff  ff ff 00 ff  ff ff 00 ff  0c 20 0f 52
			10 d8 00 ff
		];
		size = <16777216>;        /* 2MB = 16Mbit */
		has-dpd;
		t-enter-dpd = <3000>;
		t-exit-dpd = <50000>;     /* 50ms for reliable wakeup */
		/* quad-enable not needed for single-bit mode */
	};
};

zephyr_udc0: &usbd {
	compatible = "nordic,nrf-usbd";
	status = "okay";

	cdc_acm_uart: cdc_acm_uart {
		compatible = "zephyr,cdc-acm-uart";
	};
};

/* Arduino MeshCore compatible partition layout (SoftDevice v7) */
#include "../../common/nrf52_partitions_sdv7.dtsi"

/* External QSPI flash partitions */
&qspi_flash {
	partitions {
		compatible = "fixed-partitions";
		#address-cells = <1>;
		#size-cells = <1>;

		/* Full 2MB for LittleFS storage */
		qspi_storage_partition: partition@0 {
			label = "qspi_storage";
			reg = <0x00000000 0x00200000>;
		};
	};
};
